                                                                Memory usage: ▁▂▃▃▅▆▇▇▇▅▇▇▇▆▇▇▇▇▆▇█▆▇▆▇▆▆ (max: 337.253 MB, growth rate:  10%)                                                                
                                                          /home/herm/.git/dev-UA/src/a_star.py: % of time =  99.42% (4m:43.378s) out of 4m:44.692s.                                                           
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                                                                                               
       │Time   │–––––– │––––… │–––––– │Memory │–––––– │–––––––––––    │Copy   │                                                                                                                               
  Line │Python │native │syst… │GPU    │Python │peak   │timeline/%     │(MB/s) │/home/herm/.git/dev-UA/src/a_star.py                                                                                           
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │      │       │       │       │               │       │import xarray as xr                                                                                                            
     2 │       │       │      │       │       │       │               │       │import numpy as np                                                                                                             
     3 │       │       │      │       │       │       │               │       │import matplotlib.pyplot as plt                                                                                                
     4 │       │       │      │       │       │       │               │       │import utils                                                                                                                   
     5 │       │       │      │       │       │       │               │       │from typing import List, Type, Tuple, TypeAlias, NamedTuple                                                                    
     6 │       │       │      │       │       │       │               │       │                                                                                                                               
     7 │       │       │      │       │       │       │               │       │                                                                                                                               
     8 │       │       │      │       │       │       │               │       │                                                                                                                               
     9 │       │       │      │       │       │       │               │       │utils.print_entrypoint(__name__, __file__)                                                                                     
    10 │       │       │      │       │       │       │               │       │import graph_creation                                                                                                          
    11 │       │       │      │       │       │       │               │       │from ship_class import Ship                                                                                                    
    12 │       │       │      │       │       │       │               │       │import ship_class                                                                                                              
    13 │       │       │      │       │       │       │               │       │from fuel_class import Fuel                                                                                                    
    14 │       │       │      │       │       │       │               │       │import fuel_class                                                                                                              
    15 │       │       │      │       │       │       │               │       │import data                                                                                                                    
    16 │       │       │      │       │       │       │               │       │coordinate_data = data.dataset['sea_ice_thickness'].coords                                                                     
    17 │       │       │      │       │       │       │               │       │latitude_data, longitude_data = coordinate_data['lat'].to_numpy(), coordinate_data['lon'].to_numpy()                           
    18 │       │       │      │       │       │       │               │       │mean_ice_thickness = np.nanmean(data.ice_values) # (1 * np.nanstd(only_values_ice_thickness))                                  
    19 │       │       │      │       │       │       │               │       │HEURISTIC_FUEL = fuel_class.fuel_list[2]                                                                                       
    20 │       │       │      │       │       │       │               │       │HEURISTIC_THICKNESS = 0.0                                                                                                      
    21 │       │       │      │       │       │       │               │       │# ===================================================================                                                          
    22 │       │       │      │       │       │       │               │       │# Type Definitions                                                                                                             
    23 │       │       │      │       │       │       │               │       │Latitude: TypeAlias = float                                                                                                    
    24 │       │       │      │       │       │       │               │       │''' Latitude : float, alias for latitude values                                                                                
    25 │       │       │      │       │       │       │               │       │Meant as a marker to show function API usage                                                                                   
    26 │       │       │      │       │       │       │               │       │'''                                                                                                                            
    27 │       │       │      │       │       │       │               │       │Longitude: TypeAlias = float                                                                                                   
    28 │       │       │      │       │       │       │               │       │''' Longitude : float, alias for longitude values                                                                              
    29 │       │       │      │       │       │       │               │       │Pair to latitude                                                                                                               
    30 │       │       │      │       │       │       │               │       │'''                                                                                                                            
    31 │       │       │      │       │       │       │               │       │class CoordinateClass():                                                                                                       
    32 │       │       │      │       │       │       │               │       │    def __init__(self, latitude: Latitude, longitude: Longitude):                                                              
    33 │       │       │      │       │       │       │               │       │        self.latitude: Latitude = latitude                                                                                     
    34 │       │       │      │       │       │       │               │       │        self.longitude: Longitude = longitude                                                                                  
    35 │       │       │      │       │       │       │               │       │    def great_circle(self, other: Type['__class__']):                                                                          
    36 │       │       │      │       │       │       │               │       │        return great_circle(self.latitude, self.longitude, other.latitude, other.longitude)                                    
    37 │       │       │      │       │       │       │               │       │# ===================================================================                                                          
    38 │       │       │      │       │       │       │               │       │MEAN_EARTH_RADIUS_METERS = 6_371_000.0                                                                                         
    39 │       │       │      │       │       │       │               │       │from attrs import define, field                                                                                                
    40 │       │       │      │       │       │       │               │       │@define                                                                                                                        
    41 │       │       │      │       │       │       │               │       │class Coordinate:                                                                                                              
    42 │       │       │      │       │       │       │               │       │    lat: float                                                                                                                 
    43 │       │       │      │       │       │       │               │       │    lon: float                                                                                                                 
    44 │       │       │      │       │       │       │               │       │    # def __hash__(self):                                                                                                      
    45 │       │       │      │       │       │       │               │       │    #     return hash((self.lat, self.lon))                                                                                    
    46 │       │       │      │       │       │       │               │       │    def __str__(self):                                                                                                         
    47 │       │       │      │       │       │       │               │       │        return f"({self.lat},{self.lon})"                                                                                      
    48 │       │       │      │       │       │       │               │       │    def great_circle(self, other: Type['__class__']) -> float:                                                                 
    49 │       │       │      │       │       │       │               │       │        phi1, phi2 = np.deg2rad(self.lat), np.deg2rad(other.lat)                                                               
    50 │       │       │      │       │       │       │               │       │        phid = np.deg2rad(other.lat - self.lat)                                                                                
    51 │       │       │      │       │       │       │               │       │        lamd = np.deg2rad(other.lon - self.lon)                                                                                
    52 │       │       │      │       │       │       │               │       │                                                                                                                               
    53 │       │       │      │       │       │       │               │       │        a = (np.sin(phid / 2) * np.sin(phid / 2)) + np.cos(phi1) * np.cos(phi2) * (np.sin(lamd / 2) * np.sin(lamd / 2))        
    54 │       │       │      │       │       │       │               │       │        c = 2 * np.arctan2(np.sqrt(a), np.sqrt(1 - a))                                                                         
    55 │       │       │      │       │       │       │               │       │                                                                                                                               
    56 │       │       │      │       │       │       │               │       │        return c * MEAN_EARTH_RADIUS_METERS                                                                                    
    57 │       │       │      │       │       │       │               │       │    # def to_node(self) -> Node:                                                                                               
    58 │       │       │      │       │       │       │               │       │@define                                                                                                                        
    59 │       │       │      │       │       │       │               │       │class Node:                                                                                                                    
    60 │       │       │      │       │       │       │               │       │    x: int                                                                                                                     
    61 │       │       │      │       │       │       │               │       │    y: int                                                                                                                     
    62 │       │       │      │       │       │       │               │       │    coord: Coordinate                                                                                                          
    63 │       │       │      │       │       │       │               │       │    thickness: float                                                                                                           
    64 │       │       │      │       │       │       │               │       │    def __hash__(self):                                                                                                        
    65 │       │       │      │       │       │       │               │       │        return hash((self.x, self.y))                                                                                          
    66 │       │       │      │       │       │       │               │       │    def delta(self, other: 'Node') -> tuple[int, int]:                                                                         
    67 │       │       │      │       │       │       │               │       │        return (abs(other.y - self.y), abs(other.x - self.x))                                                                  
    68 │       │       │      │       │       │       │               │       │    def diagonal_to(self, other: 'Node') -> int:                                                                               
    69 │       │       │      │       │       │       │               │       │        return max(self.delta(other))                                                                                          
    70 │       │       │      │       │       │       │               │       │    def great_circle_to(self, other: 'Node') -> float:                                                                         
    71 │       │       │      │       │       │       │               │       │        return self.coord.great_circle(other.coord)                                                                            
    72 │       │       │      │       │       │       │               │       │    def distance_to(self, other: 'Node') -> float:                                                                             
    73 │       │       │      │       │       │       │               │       │        return np.sqrt((self.x ** 2) + (self.y ** 2))                                                                          
    74 │       │       │      │       │       │       │               │       │    def bias(self, other: 'Node') -> float:                                                                                    
    75 │       │       │      │       │       │       │               │       │        delta_y, delta_x = self.delta(other)                                                                                   
    76 │       │       │      │       │       │       │               │       │        percentage_x: float = delta_x / 432.0                                                                                  
    77 │       │       │      │       │       │       │               │       │        percentage_y: float = delta_y / 432.0                                                                                  
    78 │       │       │      │       │       │       │               │       │        return 0.5 * (percentage_x + percentage_y)                                                                             
    79 │       │       │      │       │       │       │               │       │IndexPair: TypeAlias = tuple[int, int]                                                                                         
    80 │       │       │      │       │       │       │               │       │'''Node : (int, int), alias for a node                                                                                         
    81 │       │       │      │       │       │       │               │       │Defined by its relevant indices in the ice thickness dataset                                                                   
    82 │       │       │      │       │       │       │               │       │'''                                                                                                                            
    83 │       │       │      │       │       │       │               │       │class NodeClass():                                                                                                             
    84 │       │       │      │       │       │       │               │       │    def __init__(self, indices: IndexPair):                                                                                    
    85 │       │       │      │       │       │       │               │       │        self.indices: IndexPair = indices                                                                                      
    86 │       │       │      │       │       │       │               │       │        self.coordinate: CoordinateClass = CoordinateClass(latitude_data[self.indices], longitude_data[self.indices])          
    87 │       │       │      │       │       │       │               │       │        self.thickness: float = data.ice_values[self.indices]                                                                  
    88 │       │       │      │       │       │       │               │       │                                                                                                                               
    89 │       │       │      │       │       │       │               │       │    def diagonal_distance(self, other: Type['__class__']) -> int:                                                              
    90 │       │       │      │       │       │       │               │       │        delta_y = abs(other[0] - self[0])                                                                                      
    91 │       │       │      │       │       │       │               │       │        delta_x = abs(other[1] - self[1])                                                                                      
    92 │       │       │      │       │       │       │               │       │        return max(delta_y, delta_x)                                                                                           
    93 │       │       │      │       │       │       │               │       │                                                                                                                               
    94 │       │       │      │       │       │       │               │       │NodeSet: TypeAlias = list[IndexPair]                                                                                           
    95 │       │       │      │       │       │       │               │       │'''NodeSet : (int, int) list, alias for a collection of nodes                                                                  
    96 │       │       │      │       │       │       │               │       │Often used to imply paths as well                                                                                              
    97 │       │       │      │       │       │       │               │       │'''                                                                                                                            
    98 │       │       │      │       │       │       │               │       │class NodeSetC():                                                                                                              
    99 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   100 │       │       │      │       │       │       │               │       │        self.nodes = []                                                                                                        
   101 │       │       │      │       │       │       │               │       │    def push(self, node: NodeClass):                                                                                           
   102 │       │       │      │       │       │       │               │       │        self.nodes.append(node)                                                                                                
   103 │       │       │      │       │       │       │               │       │NodeMap: TypeAlias = dict[IndexPair, IndexPair]                                                                                
   104 │       │       │      │       │       │       │               │       │'''NodeMapping : (int -> int) list, alias for a dict of nodes                                                                  
   105 │       │       │      │       │       │       │               │       │Used to reconstruct path and keep track of parent nodes in path                                                                
   106 │       │       │      │       │       │       │               │       │'''                                                                                                                            
   107 │       │       │      │       │       │       │               │       │class NodeMapC():                                                                                                              
   108 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   109 │       │       │      │       │       │       │               │       │        self.map = {}                                                                                                          
   110 │       │       │      │       │       │       │               │       │    def insert(self, _from: NodeClass, _to: NodeClass):                                                                        
   111 │       │       │      │       │       │       │               │       │        self.map[_from] = _to                                                                                                  
   112 │       │       │      │       │       │       │               │       │# ===================================================================                                                          
   113 │       │       │      │       │       │       │               │       │Score: TypeAlias = float                                                                                                       
   114 │       │       │      │       │       │       │               │       │'''Score : float, alias for various types of scores around the program                                                         
   115 │       │       │      │       │       │       │               │       │Meant to show intention of function, or its return value                                                                       
   116 │       │       │      │       │       │       │               │       │'''                                                                                                                            
   117 │       │       │      │       │       │       │               │       │ScoreSet: TypeAlias = dict[IndexPair, Score]                                                                                   
   118 │       │       │      │       │       │       │               │       │'''ScoreSet : ((int, int), float) dict, alias for g score and f score types                                                    
   119 │       │       │      │       │       │       │               │       │'''                                                                                                                            
   120 │       │       │      │       │       │       │               │       │HeapItem: TypeAlias = tuple[Score, IndexPair]                                                                                  
   121 │       │       │      │       │       │       │               │       │'''HeapItem: (float, (int, int)), alias for the items kept in the heap                                                         
   122 │       │       │      │       │       │       │               │       │The first item must be a float,                                                                                                
   123 │       │       │      │       │       │       │               │       │'''                                                                                                                            
   124 │       │       │      │       │       │       │               │       │Heap: TypeAlias = list[HeapItem]                                                                                               
   125 │       │       │      │       │       │       │               │       │'''Heap : (float, (int, int)) list, alias for our binary heap                                                                  
   126 │       │       │      │       │       │       │               │       │IDE support, etc, helps a lot in debugging and keeps our code clear in intention                                               
   127 │       │       │      │       │       │       │               │       │'''                                                                                                                            
   128 │       │       │      │       │       │       │               │       │SearchResult: TypeAlias = tuple[NodeSet, Score, bool]                                                                          
   129 │       │       │      │       │       │       │               │       │'''SearchResult : ((int, int) list, float, bool), alias for the return type of A*                                              
   130 │       │       │      │       │       │       │               │       │Meant to condense function signature a bit, while keeping the intention of the code clear                                      
   131 │       │       │      │       │       │       │               │       │'''                                                                                                                            
   132 │       │       │      │       │       │       │               │       │                                                                                                                               
   133 │       │       │      │       │       │       │               │       │                                                                                                                               
   134 │       │       │      │       │       │       │               │       │def find_closest_indices(coordinate: Coordinate) -> tuple[int, int]:                                                           
   135 │       │       │      │       │       │       │               │       │    '''Finds index in the dataset corresponding to the                                                                         
   136 │       │       │      │       │       │       │               │       │    coordinate closest to the provided coordinate                                                                              
   137 │       │       │      │       │       │       │               │       │                                                                                                                               
   138 │       │       │      │       │       │       │               │       │    :param coordinate: tuple[float, float] - Coordinate to find index of (lat, lon)                                            
   139 │       │       │      │       │       │       │               │       │    :return: tuple[int, int] - The indices of the coordinate point                                                             
   140 │       │       │      │       │       │       │               │       │       '''                                                                                                                     
   141 │       │       │      │       │       │       │               │       │    latitude_difference = np.apply_along_axis(lambda x: abs(coordinate.lat - x), 0, latitude_data)                             
   142 │       │       │      │       │       │       │               │       │    longitude_difference = np.apply_along_axis(lambda x: abs(coordinate.lon - x), 0, longitude_data)                           
   143 │       │       │      │       │       │       │               │       │    arr_difference = np.apply_along_axis(lambda x: x[0] + x[1], 2, np.dstack((latitude_difference, longitude_difference)))     
   144 │       │       │      │       │       │       │               │       │                                                                                                                               
   145 │       │       │      │       │       │       │               │       │    # y_idx, x_idx = np.unravel_index(indices=np.argmin(arr_difference), shape=np.shape(arr_difference))                       
   146 │       │       │      │       │       │       │               │       │    min_indices = np.argmin(arr_difference)                                                                                    
   147 │       │       │      │       │       │       │               │       │    y_idx, x_idx = np.unravel_index(indices=min_indices, shape=np.shape(arr_difference))                                       
   148 │       │       │      │       │       │       │               │       │    # thickness = data.ice_values[y, x]                                                                                        
   149 │       │       │      │       │       │       │               │       │    # return Node(y = y, x = x, coord = coordinate, thickness = data.ice_values[y, x])                                         
   150 │       │       │      │       │       │       │               │       │    return y_idx, x_idx                                                                                                        
   151 │       │       │      │       │       │       │               │       │                                                                                                                               
   152 │       │       │      │       │       │       │               │       │def find_closest_coordinate(coordinate: Coordinate) -> Coordinate:                                                             
   153 │       │       │      │       │       │       │               │       │    '''Find a coordinate's closest coordinate in our coordinate dataset                                                        
   154 │       │       │      │       │       │       │               │       │                                                                                                                               
   155 │       │       │      │       │       │       │               │       │    :param coordinate: tuple[float, float] - The coordinate in question (lat, lon)                                             
   156 │       │       │      │       │       │       │               │       │    :return: tuple[float, float] - The coordinate's closest match                                                              
   157 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   158 │       │       │      │       │       │       │               │       │    node: tuple[int, int] = find_closest_indices(coordinate)                                                                   
   159 │       │       │      │       │       │       │               │       │    coordinate: Coordinate = (latitude_data[node], longitude_data[node])                                                       
   160 │       │       │      │       │       │       │               │       │    return coordinate                                                                                                          
   161 │       │       │      │       │       │       │               │       │# Initializing A* search algorithm                                                                                             
   162 │       │       │      │       │       │       │               │       │                                                                                                                               
   163 │       │       │      │       │       │       │               │       │from scipy import stats                                                                                                        
   164 │       │       │      │       │       │       │               │       │                                                                                                                               
   165 │       │       │      │       │       │       │               │       │MEAN_EARTH_RADIUS_METERS = 6_371_000.0                                                                                         
   166 │       │       │      │       │       │       │               │       │def great_circle(                                                                                                              
   167 │       │       │      │       │       │       │               │       │        lat1: Latitude, lon1: Longitude,                                                                                       
   168 │       │       │      │       │       │       │               │       │        lat2: Latitude, lon2: Longitude                                                                                        
   169 │       │       │      │       │       │       │               │       │        ) -> float:                                                                                                            
   170 │       │       │      │       │       │       │               │       │    ''' Calculates distance between coordinates                                                                                
   171 │       │       │      │       │       │       │               │       │    :param lat1: float - Latitude of initial point                                                                             
   172 │       │       │      │       │       │       │               │       │    :param lon1: float - Longitude of initial point                                                                            
   173 │       │       │      │       │       │       │               │       │    :param lat2: float - Latitude of final point                                                                               
   174 │       │       │      │       │       │       │               │       │    :param lon2: float - Longitude of final point                                                                              
   175 │       │       │      │       │       │       │               │       │    :return: float - Distance between the points                                                                               
   176 │       │       │      │       │       │       │               │       │                                                                                                                               
   177 │       │       │      │       │       │       │               │       │    Uses the haversine formula to return distance between coordinate points                                                    
   178 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   179 │       │       │      │       │       │       │               │       │                                                                                                                               
   180 │       │       │      │       │       │       │               │       │    phi1, phi2 = np.deg2rad(lat1), np.deg2rad(lat2)                                                                            
   181 │       │       │      │       │       │       │               │       │    phid = np.deg2rad(lat2 - lat1)                                                                                             
   182 │       │       │      │       │       │       │               │       │    lamd = np.deg2rad(lon2 - lon1)                                                                                             
   183 │       │       │      │       │       │       │               │       │                                                                                                                               
   184 │       │       │      │       │       │       │               │       │    a = (np.sin(phid / 2) * np.sin(phid / 2)) + np.cos(phi1) * np.cos(phi2) * (np.sin(lamd / 2) * np.sin(lamd / 2))            
   185 │       │       │      │       │       │       │               │       │    c = 2 * np.arctan2(np.sqrt(a), np.sqrt(1 - a))                                                                             
   186 │       │       │      │       │       │       │               │       │                                                                                                                               
   187 │       │       │      │       │       │       │               │       │    return c * MEAN_EARTH_RADIUS_METERS                                                                                        
   188 │       │       │      │       │       │       │               │       │                                                                                                                               
   189 │       │       │      │       │       │       │               │       │ICE_THICKNESS_LIMIT = 2.1                                                                                                      
   190 │       │       │      │       │       │       │               │       │def cost(                                                                                                                      
   191 │       │       │      │       │       │       │               │       │        node: Node,                                                                                                            
   192 │       │       │      │       │       │       │               │       │        neighbor: Node,                                                                                                        
   193 │       │       │      │       │       │       │               │       │        ship: Type[Ship]                                                                                                       
   194 │       │       │      │       │       │       │               │       │        ) -> Score:                                                                                                            
   195 │       │       │      │       │       │       │               │       │    ''' Cost function [g(n)]                                                                                                   
   196 │       │       │      │       │       │       │               │       │    :param node: Node - The indices of the node                                                                                
   197 │       │       │      │       │       │       │               │       │    :param neighbor: Node - The indicies of the neighbor                                                                       
   198 │       │       │      │       │       │       │               │       │    :param ship: Type[Ship] - The ship in question                                                                             
   199 │       │       │      │       │       │       │               │       │    :return: float - The estimated cost between node and neighbor                                                              
   200 │       │       │      │       │       │       │               │       │                                                                                                                               
   201 │       │       │      │       │       │       │               │       │    Using the same calculation as the heuristic,                                                                               
   202 │       │       │      │       │       │       │               │       │    this function returns the actual cost, using the average of the                                                            
   203 │       │       │      │       │       │       │               │       │    node thickness and the neighbor thickness, as well as a specified fuel                                                     
   204 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   205 │       │       │      │       │       │       │               │       │    estimated_thickness = 0.5 * (node.thickness + neighbor.thickness)                                                          
   206 │       │       │      │       │       │       │               │       │                                                                                                                               
   207 │       │       │      │       │       │       │               │       │    if estimated_thickness <= ICE_THICKNESS_LIMIT:                                                                             
   208 │       │       │      │       │       │       │               │       │        estimated_distance = node.coord.great_circle(neighbor.coord)                                                           
   209 │       │       │      │       │       │       │               │       │        estimated_cost = ship.get_cost(estimated_thickness, estimated_distance)                                                
   210 │       │       │      │       │       │       │               │       │    else:                                                                                                                      
   211 │       │       │      │       │       │       │               │       │        estimated_cost = float('inf')                                                                                          
   212 │       │       │      │       │       │       │               │       │                                                                                                                               
   213 │       │       │      │       │       │       │               │       │    return estimated_cost                                                                                                      
   214 │       │       │      │       │       │       │               │       │                                                                                                                               
   215 │       │       │      │       │       │       │               │       │INACCURACY_CONSTANT: float = 0.001                                                                                             
   216 │       │       │      │       │       │       │               │       │WEIGHT_BASE: float = 1.000 + INACCURACY_CONSTANT                                                                               
   217 │       │       │      │       │       │       │               │       │EPSILON: float = 0.01                                                                                                          
   218 │       │       │      │       │       │       │               │       │def heuristic(                                                                                                                 
   219 │       │       │      │       │       │       │               │       │        node: Node,                                                                                                            
   220 │       │       │      │       │       │       │               │       │        goal: Node,                                                                                                            
   221 │       │       │      │       │       │       │               │       │        ship: Type[Ship]                                                                                                       
   222 │       │       │      │       │       │       │               │       │        ) -> Score:                                                                                                            
   223 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   224 │       │       │      │       │       │       │               │       │    heuristic estimate (Diagonal distance) [h(n)]                                                                              
   225 │       │       │      │       │       │       │               │       │    Estimate of cost to reach goal node from specified node.                                                                   
   226 │       │       │      │       │       │       │               │       │                                                                                                                               
   227 │       │       │      │       │       │       │               │       │    :param node: tuple[int, int] - The indices of the current node                                                             
   228 │       │       │      │       │       │       │               │       │    :param goal: tuple[int, int] - The indices of the goal node                                                                
   229 │       │       │      │       │       │       │               │       │    :param ship: Type[Ship] - The ship to calculate for                                                                        
   230 │       │       │      │       │       │       │               │       │    :return: float - The overestimated cost to reach the goal                                                                  
   231 │       │       │      │       │       │       │               │       │                                                                                                                               
   232 │       │       │      │       │       │       │               │       │    ==GOAL==                                                                                                                   
   233 │       │       │      │       │       │       │               │       │    The goal of the heuristic is to provide an overestimate at every point,                                                    
   234 │       │       │      │       │       │       │               │       │    thus the fuel used to calculate the basal rate is Hydrogen, the most expensive                                             
   235 │       │       │      │       │       │       │               │       │    fuel found through the graphs created elsewhere in the program.                                                            
   236 │       │       │      │       │       │       │               │       │                                                                                                                               
   237 │       │       │      │       │       │       │               │       │    ==WEIGHTING==                                                                                                              
   238 │       │       │      │       │       │       │               │       │    The weighting here is very important. Under development, it was often                                                      
   239 │       │       │      │       │       │       │               │       │    found that a too 'realistic' estimate, would result in infinite search                                                     
   240 │       │       │      │       │       │       │               │       │    loops, as all neighboring path segments would seem equally ideal,                                                          
   241 │       │       │      │       │       │       │               │       │    especially in case of paths along open water (no ice). Additionally,                                                       
   242 │       │       │      │       │       │       │               │       │    due to the number of times it would be run, any added complexity would                                                     
   243 │       │       │      │       │       │       │               │       │    greatly impact the runtime of the search.                                                                                  
   244 │       │       │      │       │       │       │               │       │                                                                                                                               
   245 │       │       │      │       │       │       │               │       │        The idea is to use a weighted approach.                                                                                
   246 │       │       │      │       │       │       │               │       │        In order to ensure the estimate is always a bit high, we define a term                                                 
   247 │       │       │      │       │       │       │               │       │        called the weighting exponent.                                                                                         
   248 │       │       │      │       │       │       │               │       │                                                                                                                               
   249 │       │       │      │       │       │       │               │       │        WEIGHT_BASE : the constant part of the weighting exponent                                                              
   250 │       │       │      │       │       │       │               │       │        EPSILON : weight of error percentage increment,                                                                        
   251 │       │       │      │       │       │       │               │       │        delta x : absolute difference of given x indices                                                                       
   252 │       │       │      │       │       │       │               │       │        delta y : absolute difference of given y indices                                                                       
   253 │       │       │      │       │       │       │               │       │        percent error of x : delta x divided by x index full span,                                                             
   254 │       │       │      │       │       │       │               │       │        percent error of y : delta y divided by y index full span,                                                             
   255 │       │       │      │       │       │       │               │       │        sigma x : EPSILON times percent error of x,                                                                            
   256 │       │       │      │       │       │       │               │       │        sigma y : EPSILON times percent error of y,                                                                            
   257 │       │       │      │       │       │       │               │       │        weighting exponent : WEIGHT_BASE + sigma x + sigma y,                                                                  
   258 │       │       │      │       │       │       │               │       │        distance estimate : great circle distance of given coordinates,                                                        
   259 │       │       │      │       │       │       │               │       │        weighted distance : distance estimate, raised to the power of the weighting exponent                                   
   260 │       │       │      │       │       │       │               │       │                                                                                                                               
   261 │       │       │      │       │       │       │               │       │        The final cost estimate is then calculated as the unit cost of the ship,                                               
   262 │       │       │      │       │       │       │               │       │        which is set at the beginning of the journey (set to the fuel to compare to                                            
   263 │       │       │      │       │       │       │               │       │        which by default is Hydrogen, due to its high price), times this weighted                                              
   264 │       │       │      │       │       │       │               │       │        distance.                                                                                                              
   265 │       │       │      │       │       │       │               │       │                                                                                                                               
   266 │       │       │      │       │       │       │               │       │    The result is that the algorithm will greatly overestimate when far from the point.                                        
   267 │       │       │      │       │       │       │               │       │    This is very useful in certain cases, such as in the route "Mongstad to Mizushima"                                         
   268 │       │       │      │       │       │       │               │       │    in the test paths. For this route, the algorithm can tend to prefer path length                                            
   269 │       │       │      │       │       │       │               │       │    a bit too much, due to the fact that a regular distance estimate would fail to                                             
   270 │       │       │      │       │       │       │               │       │    take into account that the goal is on the other side of a landmass.                                                        
   271 │       │       │      │       │       │       │               │       │    In order to minimize runtime inefficiency, a "dumb" way of predicting this was needed.                                     
   272 │       │       │      │       │       │       │               │       │                                                                                                                               
   273 │       │       │      │       │       │       │               │       │    The weighting exponent is the key to this "dumb" way.                                                                      
   274 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   275 │       │       │      │       │       │       │               │       │    # print('HEURISTIC')                                                                                                       
   276 │       │       │      │       │       │       │               │       │    # FLIPPED                                                                                                                  
   277 │       │       │      │       │       │       │               │       │    # x1, y1 = node                                                                                                            
   278 │       │       │      │       │       │       │               │       │    # x2, y2 = goal                                                                                                            
   279 │       │       │      │       │       │       │               │       │    # y1, x1 = node                                                                                                            
   280 │       │       │      │       │       │       │               │       │    # y2, x2 = goal                                                                                                            
   281 │       │       │      │       │       │       │               │       │                                                                                                                               
   282 │       │       │      │       │       │       │               │       │    # delta_x = abs(goal.x - node.x)                                                                                           
   283 │       │       │      │       │       │       │               │       │    # delta_y = abs(goal.y - node.y)                                                                                           
   284 │       │       │      │       │       │       │               │       │    delta_y, delta_x = node.delta(goal)                                                                                        
   285 │       │       │      │       │       │       │               │       │                                                                                                                               
   286 │       │       │      │       │       │       │               │       │    percent_x: int = delta_x / 432                                                                                             
   287 │       │       │      │       │       │       │               │       │    sigma_x: float = EPSILON * float(percent_x)                                                                                
   288 │       │       │      │       │       │       │               │       │                                                                                                                               
   289 │       │       │      │       │       │       │               │       │    percent_y: int = delta_y / 432                                                                                             
   290 │       │       │      │       │       │       │               │       │    sigma_y: float = EPSILON * float(percent_y)                                                                                
   291 │       │       │      │       │       │       │               │       │                                                                                                                               
   292 │       │       │      │       │       │       │               │       │    weight_sigma: float = sigma_x + sigma_y                                                                                    
   293 │       │       │      │       │       │       │               │       │                                                                                                                               
   294 │       │       │      │       │       │       │               │       │    diagonal_distance: int = max(delta_x, delta_y)                                                                             
   295 │       │       │      │       │       │       │               │       │    diagonal_distance_ratio: int = diagonal_distance / 432                                                                     
   296 │       │       │      │       │       │       │               │       │                                                                                                                               
   297 │       │       │      │       │       │       │               │       │    weighting_exponent: float = WEIGHT_BASE - weight_sigma                                                                     
   298 │       │       │      │       │       │       │               │       │                                                                                                                               
   299 │       │       │      │       │       │       │               │       │    # lat1 = latitude_data[node]                                                                                               
   300 │       │       │      │       │       │       │               │       │    # lat2 = latitude_data[goal]                                                                                               
   301 │       │       │      │       │       │       │               │       │                                                                                                                               
   302 │       │       │      │       │       │       │               │       │    # lon1 = longitude_data[node]                                                                                              
   303 │       │       │      │       │       │       │               │       │    # lon2 = longitude_data[goal]                                                                                              
   304 │       │       │      │       │       │       │               │       │                                                                                                                               
   305 │       │       │      │       │       │       │               │       │    # great_circle_distance = great_circle(                                                                                    
   306 │       │       │      │       │       │       │               │       │    #     node.coord.lat, node.coord.lon,                                                                                      
   307 │       │       │      │       │       │       │               │       │    #     goal.coord.lat, goal.coord.lon)                                                                                      
   308 │       │       │      │       │       │       │               │       │                                                                                                                               
   309 │       │       │      │       │       │       │               │       │    # weighted_distance = np.power(great_circle_distance, weighting_exponent)                                                  
   310 │       │       │      │       │       │       │               │       │    # weighted_distance = 1.001 * great_circle_distance                                                                        
   311 │       │       │      │       │       │       │               │       │    # if utils.verbose_mode:                                                                                                   
   312 │       │       │      │       │       │       │               │       │    # estimated_distance = node.diagonal_to(goal)                                                                              
   313 │       │       │      │       │       │       │               │       │    estimated_distance = node.coord.great_circle(goal.coord)                                                                   
   314 │       │       │      │       │       │       │               │       │    print('dist')                                                                                                              
   315 │       │       │      │       │       │       │               │       │    print(estimated_distance)                                                                                                  
   316 │       │       │      │       │       │       │               │       │                                                                                                                               
   317 │       │       │      │       │       │       │               │       │    bias = node.bias(goal) / 10.0                                                                                              
   318 │       │       │      │       │       │       │               │       │    weighted_distance = (1.0 + bias) * estimated_distance                                                                      
   319 │       │       │      │       │       │       │               │       │    print('weighted')                                                                                                          
   320 │       │       │      │       │       │       │               │       │    print(weighted_distance)                                                                                                   
   321 │       │       │      │       │       │       │               │       │                                                                                                                               
   322 │       │       │      │       │       │       │               │       │    delta_distance = abs(weighted_distance - estimated_distance)                                                               
   323 │       │       │      │       │       │       │               │       │    percent_delta = (weighted_distance / estimated_distance) - 1.0                                                             
   324 │       │       │      │       │       │       │               │       │    print('delta')                                                                                                             
   325 │       │       │      │       │       │       │               │       │    print(str(weighted_distance) + ' ' + str(percent_delta))                                                                   
   326 │       │       │      │       │       │       │               │       │    estimated_cost = ship.unit_cost * weighted_distance                                                                        
   327 │       │       │      │       │       │       │               │       │    return estimated_cost                                                                                                      
   328 │       │       │      │       │       │       │               │       │                                                                                                                               
   329 │       │       │      │       │       │       │               │       │def reconstruct_path(                                                                                                          
   330 │       │       │      │       │       │       │               │       │        current_node: Node,                                                                                                    
   331 │       │       │      │       │       │       │               │       │        came_from: dict[Node, Node]                                                                                            
   332 │       │       │      │       │       │       │               │       │        ) -> NodeSet:                                                                                                          
   333 │       │       │      │       │       │       │               │       │    ''' Returns reconstructed path as a list of nodes from start node to goal node                                             
   334 │       │       │      │       │       │       │               │       │    by iterating over visited nodes from the came_from set                                                                     
   335 │       │       │      │       │       │       │               │       │                                                                                                                               
   336 │       │       │      │       │       │       │               │       │    :param current_node: Node - The node to start building from                                                                
   337 │       │       │      │       │       │       │               │       │    :param came_from: dict[Node, Node] - The rest of the nodes to build from                                                   
   338 │       │       │      │       │       │       │               │       │    :return: list[Node] The reconstructed path                                                                                 
   339 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   340 │       │       │      │       │       │       │               │       │    if utils.verbose_mode:                                                                                                     
   341 │       │       │      │       │       │       │               │       │        print('\tReconstructing path...')                                                                                      
   342 │       │       │      │       │       │       │               │       │    path = [current_node]  # initializing with current_node                                                                    
   343 │       │       │      │       │       │       │               │       │    while current_node in came_from:  # iterating through came from set                                                        
   344 │       │       │      │       │       │       │               │       │        current_node = came_from[current_node]  # assign current node to the node it came from                                 
   345 │       │       │      │       │       │       │               │       │        path.insert(0,current_node)  # insert current node at the front of the path list                                       
   346 │       │       │      │       │       │       │               │       │    if utils.verbose_mode:                                                                                                     
   347 │       │       │      │       │       │       │               │       │        print('\tFinished.\n')                                                                                                 
   348 │       │       │      │       │       │       │               │       │    return path                                                                                                                
   349 │       │       │      │       │       │       │               │       │                                                                                                                               
   350 │       │       │      │       │       │       │               │       │from collections import defaultdict                                                                                            
   351 │       │       │      │       │       │       │               │       │from heapq import heapify, heappush, heappop, nsmallest                                                                        
   352 │       │       │      │       │       │       │               │       │X_BOUND = 432                                                                                                                  
   353 │       │       │      │       │       │       │               │       │Y_BOUND = 432                                                                                                                  
   354 │       │       │      │       │       │       │               │       │coordinate_set: dict[tuple[int, int], Coordinate] = {}                                                                         
   355 │       │       │      │       │       │       │               │       │node_set: dict[tuple[int, int], Node] = {}                                                                                     
   356 │       │       │      │       │       │       │               │       │for y in np.arange(0, Y_BOUND):                                                                                                
   357 │       │       │      │       │       │       │               │       │    for x in np.arange(0, X_BOUND):                                                                                            
   358 │       │       │      │       │       │       │               │       │        coordinate = Coordinate(                                                                                               
   359 │       │       │      │       │       │       │               │       │            latitude_data[y, x],                                                                                               
   360 │       │       │      │       │       │       │               │       │            longitude_data[y, x])                                                                                              
   361 │       │       │      │       │       │       │               │       │        coordinate_set[y, x] = coordinate                                                                                      
   362 │       │       │      │       │       │       │               │       │        node = Node(y, x, coordinate, data.ice_values[y, x])                                                                   
   363 │       │       │      │       │       │       │               │       │        # print(node)                                                                                                          
   364 │       │       │      │       │       │       │               │       │        node_set[y, x] = node                                                                                                  
   365 │       │       │      │       │       │       │               │       │# print(node_set.__len__())                                                                                                    
   366 │       │       │      │       │       │       │               │       │@profile                                                                                                                       
   367 │       │       │      │       │       │       │               │       │def A_star_search_algorithm(                                                                                                   
   368 │       │       │      │       │       │       │               │       │        start_coordinate: Coordinate,                                                                                          
   369 │       │       │      │       │       │       │               │       │        end_coordinate: Coordinate,                                                                                            
   370 │       │       │      │       │       │       │               │       │        ship: Type[Ship],                                                                                                      
   371 │       │       │      │       │       │       │               │       │        fuel: Type[Fuel]                                                                                                       
   372 │       │       │      │       │       │       │               │       │        ) -> tuple[list[Node], float, bool]:                                                                                   
   373 │       │       │      │       │       │       │               │       │    ''' Returns most optimal path between start_coordinate and end_coordinate                                                  
   374 │       │       │      │       │       │       │               │       │    path is chosen based on cost                                                                                               
   375 │       │       │      │       │       │       │               │       │                                                                                                                               
   376 │       │       │      │       │       │       │               │       │    :param start_coordinate: tuple[float, float] -                                                                             
   377 │       │       │      │       │       │       │               │       │    :param end_coordinate: tuple[float, float] -                                                                               
   378 │       │       │      │       │       │       │               │       │    :param ship: Type[Ship] -                                                                                                  
   379 │       │       │      │       │       │       │               │       │    :param fuel: Type[Fuel] -                                                                                                  
   380 │       │       │      │       │       │       │               │       │    :return: tuple[list[Node], float, bool]                                                                                    
   381 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   382 │       │       │      │       │       │       │               │       │    print('\tStarting A*... (this may in some cases take a while)')                                                            
   383 │       │       │      │       │       │       │               │       │                                                                                                                               
   384 │       │       │      │       │       │       │               │       │    # There may be better values to choose here                                                                                
   385 │       │       │      │       │       │       │               │       │    ship.set_target_velocity(0.88)                                                                                             
   386 │       │       │      │       │       │       │               │       │    emptyset = []                                                                                                              
   387 │       │       │      │       │       │       │               │       │                                                                                                                               
   388 │       │       │      │       │       │       │               │       │    # Initialize unit cost as the cheapest overall, Methanol                                                                   
   389 │       │       │      │       │       │       │               │       │    ship.set_fuel(fuel_class.Methanol())                                                                                       
   390 │       │       │      │       │       │       │               │       │    ship.set_unit_cost()                                                                                                       
   391 │       │       │      │       │       │       │               │       │                                                                                                                               
   392 │       │       │      │       │       │       │               │       │    # Set to actual fuel in use                                                                                                
   393 │       │       │      │       │       │       │               │       │    ship.set_fuel(fuel)                                                                                                        
   394 │       │       │      │       │       │       │               │       │                                                                                                                               
   395 │       │       │      │       │       │       │               │       │    # FLIPPED                                                                                                                  
   396 │       │       │      │       │       │       │               │       │    # Get node indices                                                                                                         
   397 │       │       │      │       │       │       │               │       │    # start_y, start_x = find_closest_index(start_coordinate)                                                                  
   398 │       │       │      │       │       │       │               │       │    # goal_y, goal_x = find_closest_index(end_coordinate)                                                                      
   399 │       │       │      │       │       │       │               │       │                                                                                                                               
   400 │       │       │      │       │       │       │               │       │    # y_res, x_res = 1, 1                                                                                                      
   401 │       │       │      │       │       │       │               │       │    # start = (x_res * start_x, y_res * start_y)                                                                               
   402 │       │       │      │       │       │       │               │       │    # goal = (x_res * goal_x, y_res * goal_y)                                                                                  
   403 │       │       │      │       │       │       │               │       │    # Reverse, function internals demand it somehow                                                                            
   404 │       │       │      │       │       │       │               │       │    # FLIPPED                                                                                                                  
   405 │       │       │      │       │       │       │               │       │    # start: Node = (start_x, start_y)                                                                                         
   406 │       │       │      │       │       │       │               │       │    # goal: Node = (goal_x, goal_y)                                                                                            
   407 │       │       │      │       │       │       │               │       │    # Get nodes                                                                                                                
   408 │       │       │      │       │       │       │               │       │    # start: IndexPair = find_closest_index(start_coordinate)                                                                  
   409 │       │       │      │       │       │       │               │       │    # goal: IndexPair = find_closest_index(end_coordinate)                                                                     
   410 │    4% │       │      │  4%   │       │       │               │       │    start_indices: tuple[int, int] = find_closest_indices(start_coordinate)                                                    
   411 │       │       │      │       │       │       │               │       │    start: Node = node_set[start_indices]                                                                                      
   412 │       │       │      │       │       │       │               │       │    # print(start)                                                                                                             
   413 │       │       │      │       │       │       │               │       │    # print('Start is ' + str(type(start)))                                                                                    
   414 │    4% │       │      │  4%   │       │       │               │       │    goal_indices: tuple[int, int] = find_closest_indices(end_coordinate)                                                       
   415 │       │       │      │       │       │       │               │       │    goal: Node = node_set[goal_indices]                                                                                        
   416 │       │       │      │       │       │       │               │       │                                                                                                                               
   417 │       │       │      │       │       │       │               │       │                                                                                                                               
   418 │       │       │      │       │       │       │               │       │    # defining scoreing                                                                                                        
   419 │       │       │      │       │       │       │               │       │    g_score: dict[Node, float] = {}  # cost from start node to each node                                                       
   420 │       │       │      │       │       │       │               │       │    f_score: dict[Node, float] = {}                                                                                            
   421 │       │       │      │       │       │       │               │       │    # Init empty map with infinity g_score                                                                                     
   422 │       │       │      │       │       │       │               │       │    y_bound: int = np.shape(data.ice_values)[0]                                                                                
   423 │       │       │      │       │       │       │               │       │    x_bound: int = np.shape(data.ice_values)[1]                                                                                
   424 │       │       │      │       │       │       │               │       │    # for y in np.arange(0, y_bound):                                                                                          
   425 │       │       │      │       │       │       │               │       │    #     for x in np.arange(0, x_bound):                                                                                      
   426 │       │       │      │       │       │       │               │       │    #         # FLIPPED                                                                                                        
   427 │       │       │      │       │       │       │               │       │    #         g_score[y, x] = float('inf')                                                                                     
   428 │       │       │      │       │       │       │               │       │    #         f_score[y, x] = float('inf')                                                                                     
   429 │       │       │      │       │       │       │               │       │    for node in node_set.values():                                                                                             
   430 │       │       │      │       │  87%  │  392M │▁▁▂▂▂▂▂▁▁  18% │       │        g_score[node] = float('inf')                                                                                           
   431 │    2% │       │      │  1%   │  73%  │   42M │▁▁▁▁   2%      │     2 │        f_score[node] = float('inf')                                                                                           
   432 │       │       │      │       │       │       │               │       │    print(f_score.__len__())                                                                                                   
   433 │       │       │      │       │       │       │               │       │    print(g_score.__len__())                                                                                                   
   434 │       │       │      │       │       │       │               │       │                                                                                                                               
   435 │       │       │      │       │       │       │               │       │    # Estimate of cost to reach the current node                                                                               
   436 │       │       │      │       │       │       │               │       │    g_score[start] = 0.                                                                                                        
   437 │       │       │      │       │       │       │               │       │    # Estimate of cost from start node to goal node for each node                                                              
   438 │       │       │      │       │       │       │               │       │    f_score[start] = g_score[start] + heuristic(start, goal, ship)                                                             
   439 │       │       │      │       │       │       │               │       │    # initializing sets for exploring and disregarding nodes                                                                   
   440 │       │       │      │       │       │       │               │       │    came_from: dict[Node, Node] = {}  # will hold parent nodes, empty on init                                                  
   441 │       │       │      │       │       │       │               │       │                                                                                                                               
   442 │       │       │      │       │       │       │               │       │    # The closed_set will hold previously explored nodes                                                                       
   443 │       │       │      │       │       │       │               │       │    closed_set: set[Node] = set()                                                                                              
   444 │       │       │      │       │       │       │               │       │                                                                                                                               
   445 │       │       │      │       │       │       │               │       │    # The open set (heap) will hold currently explorable nodes                                                                 
   446 │       │       │      │       │       │       │               │       │    # Using binheap, since the smallest element will always                                                                    
   447 │       │       │      │       │       │       │               │       │    # be the first, drastically speeding up the search                                                                         
   448 │       │       │      │       │       │       │               │       │    open_heap: list[tuple[float, Node]] = []                                                                                   
   449 │       │       │      │       │       │       │               │       │    heapify(open_heap)                                                                                                         
   450 │       │       │      │       │       │       │               │       │    heappush(open_heap, (f_score[start], start))                                                                               
   451 │       │       │      │       │       │       │               │       │                                                                                                                               
   452 │       │       │      │       │       │       │               │       │    neighbors = [(0, 1), (0, -1), (1, 0), (1, 1), (1, -1), (-1, 0), (-1, -1), (-1, 1)]                                         
   453 │       │       │      │       │       │       │               │       │    # iterating over available nodes                                                                                           
   454 │       │       │      │       │       │       │               │       │    while open_heap:                                                                                                           
   455 │       │       │      │       │       │       │               │       │        # Get lowest f_score element                                                                                           
   456 │    1% │       │      │  2%   │       │       │               │       │        elem: tuple[float, Node] = heappop(open_heap)                                                                          
   457 │       │       │      │       │       │       │               │       │        current_node: Node = elem[1]                                                                                           
   458 │       │       │      │       │       │       │               │       │        closed_set.add(current_node)                                                                                           
   459 │       │       │      │       │       │       │               │       │        # closed_set.append(current_node)                                                                                      
   460 │       │       │      │       │       │       │               │       │                                                                                                                               
   461 │       │       │      │       │       │       │               │       │        # If at goal, return the path used                                                                                     
   462 │       │       │      │       │       │       │               │       │        if current_node.x == goal.x and current_node.y == goal.y:                                                              
   463 │       │       │      │       │       │       │               │       │            print('\tSearch successful!\n')                                                                                    
   464 │       │       │      │       │       │       │               │       │            path: list[Node] = reconstruct_path(current_node, came_from)                                                       
   465 │       │       │      │       │       │       │               │       │            final_score: Score = elem[0]                                                                                       
   466 │       │       │      │       │       │       │               │       │            result: SearchResult = path, final_score, True                                                                     
   467 │       │       │      │       │       │       │               │       │            return result                                                                                                      
   468 │       │       │      │       │       │       │               │       │                                                                                                                               
   469 │       │       │      │       │       │       │               │       │        # iterating through current node's neighbors                                                                           
   470 │       │       │      │       │       │       │               │       │        for dx, dy in neighbors:                                                                                               
   471 │       │       │      │       │       │       │               │       │            # x, y = current_node                                                                                              
   472 │       │       │      │       │       │       │               │       │            neighbor_y: int = current_node.y + dy                                                                              
   473 │       │       │      │       │       │       │               │       │            neighbor_x: int = current_node.x + dx                                                                              
   474 │       │       │      │       │       │       │               │       │            # neighbor: IndexPair = (neighbor_y, neighbor_x)                                                                   
   475 │       │       │      │       │       │       │               │       │            # If neighbor is inside chosen bounds                                                                              
   476 │       │       │      │       │       │       │               │       │            if 0 <= neighbor_x < x_bound and 0 <= neighbor_y < y_bound:                                                        
   477 │       │       │      │       │       │       │               │       │                # print(neighbor_x)                                                                                            
   478 │       │       │      │       │       │       │               │       │                neighbor: Node = node_set[neighbor_x, neighbor_y]                                                              
   479 │       │       │      │       │       │       │               │       │                # Proper control flow requires this statement to fail,                                                         
   480 │       │       │      │       │       │       │               │       │                # but the previous to pass                                                                                     
   481 │       │       │      │       │       │       │               │       │                # thickness = data.ice_values[neighbor_y, neighbor_x]                                                          
   482 │       │       │      │       │       │       │               │       │                # print(neighbor)                                                                                              
   483 │    8% │       │   3% │ 12%   │       │       │               │       │                if np.isnan(neighbor.thickness):                                                                               
   484 │       │       │      │       │       │       │               │       │                    # print('naned')                                                                                           
   485 │       │       │      │       │       │       │               │       │                    # Indeterminate data, proceed to next iteration                                                            
   486 │       │       │      │       │       │       │               │       │                    continue                                                                                                   
   487 │       │       │      │       │       │       │               │       │                # neighbor: Node = Node(                                                                                       
   488 │       │       │      │       │       │       │               │       │                #     y = neighbor_y, x = neighbor_x,                                                                          
   489 │       │       │      │       │       │       │               │       │                #     coord = Coordinate(                                                                                      
   490 │       │       │      │       │       │       │               │       │                #         lat = latitude_data[neighbor_y, neighbor_x],                                                         
   491 │       │       │      │       │       │       │               │       │                #         lon = longitude_data[neighbor_y, neighbor_x]),                                                       
   492 │       │       │      │       │       │       │               │       │                #     thickness = thickness)                                                                                   
   493 │       │       │      │       │       │       │               │       │                # if neighbor is in closed set, due to our heuristic,                                                          
   494 │       │       │      │       │       │       │               │       │                # we can guarantee a more optimal path there has been found,                                                   
   495 │       │       │      │       │       │       │               │       │                # so we can skip it                                                                                            
   496 │       │       │      │  1%   │       │       │               │       │                if neighbor in closed_set:                                                                                     
   497 │       │       │      │       │       │       │               │       │                    continue                                                                                                   
   498 │       │       │      │       │       │       │               │       │                if neighbor in came_from:                                                                                      
   499 │       │       │      │       │       │       │               │       │                    continue                                                                                                   
   500 │       │       │      │       │       │       │               │       │                # At this point the following else-statement will be skipped,                                                  
   501 │       │       │      │       │       │       │               │       │                # and the node will be considered OK                                                                           
   502 │       │       │      │       │       │       │               │       │            else:                                                                                                              
   503 │       │       │      │       │       │       │               │       │                # Current node is OOB, proceed to next iteration                                                               
   504 │       │       │      │       │       │       │               │       │                continue                                                                                                       
   505 │       │       │      │       │       │       │               │       │            # Potential g_score of neighbor                                                                                    
   506 │   10% │       │   4% │ 16%   │       │       │               │       │            tentative_g_score: float = g_score[current_node] + cost(current_node, neighbor, ship)  # changes if a smaller cos  
   507 │       │       │      │       │       │       │               │       │                                                                                                                               
   508 │       │       │      │       │       │       │               │       │            # checks if the current path to neighbor is better than previous (or none)                                         
   509 │       │       │      │       │       │       │               │       │            if tentative_g_score < g_score[neighbor]:                                                                          
   510 │       │       │      │       │       │       │               │       │                # set current node as parent node                                                                              
   511 │       │       │      │       │       │       │               │       │                came_from[neighbor] = current_node                                                                             
   512 │       │       │      │       │       │       │               │       │                                                                                                                               
   513 │       │       │      │       │       │       │               │       │                # updating g score                                                                                             
   514 │       │       │      │       │       │       │               │       │                g_score[neighbor] = tentative_g_score                                                                          
   515 │       │       │      │       │       │       │               │       │                                                                                                                               
   516 │       │       │      │       │       │       │               │       │                # total cost from start node to goal node via this neighbor                                                    
   517 │   30% │    3% │  16% │ 52%   │       │       │               │       │                f_score[neighbor] = g_score[neighbor] + heuristic(neighbor, goal, ship)                                        
   518 │       │       │      │       │       │       │               │       │                                                                                                                               
   519 │       │       │      │       │       │       │               │       │                # checking if neighbor has been explored                                                                       
   520 │       │       │      │       │       │       │               │       │                # if neighbor not in [node for (_, node) in open_heap]:                                                        
   521 │       │       │      │       │       │       │               │       │                #     heappush(open_heap, (f_score[neighbor], neighbor))  # add neighbor to set of explorable nodes            
   522 │       │       │      │  1%   │       │       │               │       │                heappush(open_heap, (f_score[neighbor], neighbor))                                                             
   523 │       │       │      │       │       │       │               │       │                                                                                                                               
   524 │       │       │      │       │       │       │               │       │    # if no path has been found                                                                                                
   525 │       │       │      │       │       │       │               │       │    print('\tSearch failed!\n')                                                                                                
   526 │       │       │      │       │       │       │               │       │    path: NodeSet = reconstruct_path(current_node, came_from)                                                                  
   527 │       │       │      │       │       │       │               │       │    final_score: Score = elem[0]                                                                                               
   528 │       │       │      │       │       │       │               │       │    result: SearchResult = path, final_score, False                                                                            
   529 │       │       │      │       │       │       │               │       │    return result                                                                                                              
   530 │       │       │      │       │       │       │               │       │                                                                                                                               
   531 │       │       │      │       │       │       │               │       │def plot_path(path: list[Node], map=None):                                                                                     
   532 │       │       │      │       │       │       │               │       │    if map == None:                                                                                                            
   533 │       │       │      │       │       │       │               │       │        map = data.init_map()                                                                                                  
   534 │       │       │      │       │       │       │               │       │    if utils.verbose_mode:                                                                                                     
   535 │       │       │      │       │       │       │               │       │        print('\tPlotting path...')                                                                                            
   536 │       │       │      │       │       │       │               │       │    [data.plot_coord(node.coord.lon, node.coord.lat, map=map)                                                                  
   537 │       │       │      │       │       │       │               │       │        for node in path                                                                                                       
   538 │       │       │      │       │       │       │               │       │        # [(node.coord.lon, node.coord.lat) for node in path]                                                                  
   539 │       │       │      │       │       │       │               │       │    ]                                                                                                                          
   540 │       │       │      │       │       │       │               │       │    print('\tFinished.\n')                                                                                                     
   541 │       │       │      │       │       │       │               │       │                                                                                                                               
   542 │       │       │      │       │       │       │               │       │                                                                                                                               
   543 │       │       │      │       │       │       │               │       │def run_search(start_coordinate, end_coordinate):                                                                              
   544 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   545 │       │       │      │       │       │       │               │       │    Runs A* on the provided coordinates, and attempts to plot the path.                                                        
   546 │       │       │      │       │       │       │               │       │    In case of a failed search, only the start-point and end-point will be                                                     
   547 │       │       │      │       │       │       │               │       │    visible in the plot (for debugging purposes etc.)                                                                          
   548 │       │       │      │       │       │       │               │       │    :param start_coordinate: List[float] - Start coordinate as [lon, lat]                                                      
   549 │       │       │      │       │       │       │               │       │    :param end_coordinate: List[float] - End coordinate as [lon, lat]                                                          
   550 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
   551 │       │       │      │       │       │       │               │       │                                                                                                                               
   552 │       │       │      │       │       │       │               │       │    path, score, search_successful = A_star_search_algorithm(start_coordinate, end_coordinate, fuel_class.fuel_list[0], ship=  
   553 │       │       │      │       │       │       │               │       │    if path != None and search_successful:                                                                                     
   554 │       │       │      │       │       │       │               │       │        plot_path(path)                                                                                                        
   555 │       │       │      │       │       │       │               │       │        data.save_coord_map(str(start_coordinate) + '_' + str(end_coordinate) + '_' + str(score) + '€')                        
   556 │       │       │      │       │       │       │               │       │        print ('New path available in images directory!')                                                                      
   557 │       │       │      │       │       │       │               │       │    else:                                                                                                                      
   558 │       │       │      │       │       │       │               │       │        map = data.init_map()                                                                                                  
   559 │       │       │      │       │       │       │               │       │                                                                                                                               
   560 │       │       │      │       │       │       │               │       │        # Find the coordinates closest to the given ones (similar to how it is done in the body of A*)                         
   561 │       │       │      │       │       │       │               │       │        # Then plot these points, and these points only                                                                        
   562 │       │       │      │       │       │       │               │       │        lon_start, lat_start = find_closest_coordinate(start_coordinate)                                                       
   563 │       │       │      │       │       │       │               │       │        # x_start, y_start = find_closest_coordinate(start_coordinate)                                                         
   564 │       │       │      │       │       │       │               │       │        # lon_start, lat_start = (longitude_data[y_start, x_start], latitude_data[y_start, x_start])                           
   565 │       │       │      │       │       │       │               │       │        data.plot_coord(lon_start, lat_start, m='.', map=map)                                                                  
   566 │       │       │      │       │       │       │               │       │                                                                                                                               
   567 │       │       │      │       │       │       │               │       │        lon_end, lat_end = find_closest_coordinate(end_coordinate)                                                             
   568 │       │       │      │       │       │       │               │       │        # x_end, y_end = find_closest_coordinate(end_coordinate)                                                               
   569 │       │       │      │       │       │       │               │       │        # lon_end, lat_end = (longitude_data[y_end, x_end], latitude_data[y_end, x_end])                                       
   570 │       │       │      │       │       │       │               │       │        data.plot_coord(lon_end, lat_end, m='.', map=map)                                                                      
   571 │       │       │      │       │       │       │               │       │                                                                                                                               
   572 │       │       │      │       │       │       │               │       │        plot_path(path, map=map)                                                                                               
   573 │       │       │      │       │       │       │               │       │        data.save_coord_map(str(start_coordinate) + '_' + str(end_coordinate) + '_failure_' + str(score) + '€')                
   574 │       │       │      │       │       │       │               │       │                                                                                                                               
   575 │       │       │      │       │       │       │               │       │        print('Check images directory to see details, there will be a new map there, containing some points for debugging.\nT  
   576 │       │       │      │       │       │       │               │       │                                                                                                                               
   577 │       │       │      │       │       │       │               │       │                                                                                                                               
   578 │       │       │      │       │       │       │               │       │                                                                                                                               
   579 │       │       │      │       │       │       │               │       │# TESTING SECTION                                                                                                              
   580 │       │       │      │       │       │       │               │       │                                                                                                                               
   581 │       │       │      │       │       │       │               │       │# defining start and end coordinates (lat,lon)                                                                                 
   582 │       │       │      │       │       │       │               │       │# start_coordinate: Coordinate = Coordinate(lat = 66.898, lon = -162.596)                                                      
   583 │       │       │      │       │       │       │               │       │# end_coordinate: Coordinate = Coordinate(lat = 68.958, lon = 33.082)                                                          
   584 │       │       │      │       │       │       │               │       │                                                                                                                               
   585 │       │       │      │       │       │       │               │       │# import distance_correction as dist_corr                                                                                      
   586 │       │       │      │       │       │       │               │       │import unittest                                                                                                                
   587 │       │       │      │       │       │       │               │       │class Port():                                                                                                                  
   588 │       │       │      │       │       │       │               │       │    def __init__(self, name: str, position: Coordinate):                                                                       
   589 │       │       │      │       │       │       │               │       │        self.name: str = name                                                                                                  
   590 │       │       │      │       │       │       │               │       │        self.position: Coordinate = position                                                                                   
   591 │       │       │      │       │       │       │               │       │        # lat, lon = position                                                                                                  
   592 │       │       │      │       │       │       │               │       │        # self.coord = Coord(lat, lon)                                                                                         
   593 │       │       │      │       │       │       │               │       │    def __str__(self) -> str:                                                                                                  
   594 │       │       │      │       │       │       │               │       │        return f"{self.name} {self.position}"                                                                                  
   595 │       │       │      │       │       │       │               │       │    def get_position(self) -> Coordinate:                                                                                      
   596 │       │       │      │       │       │       │               │       │        return self.position                                                                                                   
   597 │       │       │      │       │       │       │               │       │                                                                                                                               
   598 │       │       │      │       │       │       │               │       │class PortBaseTest(unittest.TestCase):                                                                                         
   599 │       │       │      │       │       │       │               │       │    @classmethod                                                                                                               
   600 │       │       │      │       │       │       │               │       │    def setUpClass(cls):                                                                                                       
   601 │       │       │      │       │       │       │               │       │        ''' On inherited classes, run setUp '''                                                                                
   602 │       │       │      │       │       │       │               │       │        if cls is not PortBaseTest and cls.setUp is not PortBaseTest.setUp:                                                    
   603 │       │       │      │       │       │       │               │       │            original_setUp = cls.setUp                                                                                         
   604 │       │       │      │       │       │       │               │       │            def setUpOverride(self, *args, **kwargs):                                                                          
   605 │       │       │      │       │       │       │               │       │                PortBaseTest.setUp(self)                                                                                       
   606 │       │       │      │       │       │       │               │       │                return original_setUp(self, *args, **kwargs)                                                                   
   607 │       │       │      │       │       │       │               │       │            cls.setUp = setUpOverride                                                                                          
   608 │       │       │      │       │       │       │               │       │                                                                                                                               
   609 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   610 │       │       │      │       │       │       │               │       │        ''' Invalid to test a port without any data'''                                                                         
   611 │       │       │      │       │       │       │               │       │        self.port = None                                                                                                       
   612 │       │       │      │       │       │       │               │       │                                                                                                                               
   613 │       │       │      │       │       │       │               │       │    def test_coordinate_valid(self):                                                                                           
   614 │       │       │      │       │       │       │               │       │        if self.port != None:                                                                                                  
   615 │       │       │      │       │       │       │               │       │            self.assertIsInstance(self.port.position, Coordinate)                                                              
   616 │       │       │      │       │       │       │               │       │                                                                                                                               
   617 │       │       │      │       │       │       │               │       │class Mongstad(Port):                                                                                                          
   618 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   619 │       │       │      │       │       │       │               │       │        super().__init__('MONG', Coordinate(lat = 60.810, lon = 5.032))                                                        
   620 │       │       │      │       │       │       │               │       │class MongstadTest(PortBaseTest):                                                                                              
   621 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   622 │       │       │      │       │       │       │               │       │        self.port = Mongstad()                                                                                                 
   623 │       │       │      │       │       │       │               │       │                                                                                                                               
   624 │       │       │      │       │       │       │               │       │class Mizushima(Port):                                                                                                         
   625 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   626 │       │       │      │       │       │       │               │       │        super().__init__('MIZU', Coordinate(lat = 34.504, lon = 133.714))                                                      
   627 │       │       │      │       │       │       │               │       │class MizushimaTest(PortBaseTest):                                                                                             
   628 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   629 │       │       │      │       │       │       │               │       │        self.port = Mizushima()                                                                                                
   630 │       │       │      │       │       │       │               │       │                                                                                                                               
   631 │       │       │      │       │       │       │               │       │class Kotzebue(Port):                                                                                                          
   632 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   633 │       │       │      │       │       │       │               │       │        super().__init__('KOTZ', Coordinate(lat = 66.898, lon = -162.596))                                                     
   634 │       │       │      │       │       │       │               │       │class KotzebueTest(PortBaseTest):                                                                                              
   635 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   636 │       │       │      │       │       │       │               │       │        self.port = Kotzebue()                                                                                                 
   637 │       │       │      │       │       │       │               │       │                                                                                                                               
   638 │       │       │      │       │       │       │               │       │class Murmansk(Port):                                                                                                          
   639 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   640 │       │       │      │       │       │       │               │       │        super().__init__('MURM', Coordinate(lat = 68.958, lon = 33.082))                                                       
   641 │       │       │      │       │       │       │               │       │class MurmanskTest(PortBaseTest):                                                                                              
   642 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   643 │       │       │      │       │       │       │               │       │        self.port = Murmansk()                                                                                                 
   644 │       │       │      │       │       │       │               │       │                                                                                                                               
   645 │       │       │      │       │       │       │               │       │class Reykjavik(Port):                                                                                                         
   646 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   647 │       │       │      │       │       │       │               │       │        super().__init__('REYK', Coordinate(lat = 64.963, lon = 19.103))                                                       
   648 │       │       │      │       │       │       │               │       │class ReykjavikTest(PortBaseTest):                                                                                             
   649 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   650 │       │       │      │       │       │       │               │       │        self.port = Reykjavik()                                                                                                
   651 │       │       │      │       │       │       │               │       │                                                                                                                               
   652 │       │       │      │       │       │       │               │       │class Tasiilap(Port):                                                                                                          
   653 │       │       │      │       │       │       │               │       │    def __init__(self):                                                                                                        
   654 │       │       │      │       │       │       │               │       │        super().__init__('TASI', Coordinate(lat = 65.530, lon = -37.524))                                                      
   655 │       │       │      │       │       │       │               │       │class TasiilapTest(PortBaseTest):                                                                                              
   656 │       │       │      │       │       │       │               │       │    def setUp(self):                                                                                                           
   657 │       │       │      │       │       │       │               │       │        self.port = Tasiilap()                                                                                                 
   658 │       │       │      │       │       │       │               │       │                                                                                                                               
   659 │       │       │      │       │       │       │               │       │if __name__ == '__main__':                                                                                                     
   660 │       │       │      │       │       │       │               │       │    unittest.main()                                                                                                            
   661 │       │       │      │       │       │       │               │       │                                                                                                                               
   662 │       │       │      │       │       │       │               │       │class Route():                                                                                                                 
   663 │       │       │      │       │       │       │               │       │    def __init__(self, start: Type[Port], goal: Type[Port]):                                                                   
   664 │       │       │      │       │       │       │               │       │        self.start: Type[Port] = start                                                                                         
   665 │       │       │      │       │       │       │               │       │        self.goal: Type[Port] = goal                                                                                           
   666 │       │       │      │       │       │       │               │       │    def __str__(self) -> str:                                                                                                  
   667 │       │       │      │       │       │       │               │       │        return f"Route - {self.start} - {self.goal}"                                                                           
   668 │       │       │      │       │       │       │               │       │                                                                                                                               
   669 │       │       │      │       │       │       │               │       │# mongstad: Port = Port('Mongstad', (60.810, 5.032))                                                                           
   670 │       │       │      │       │       │       │               │       │# mizushima: Port = Port('Mizushima', (34.504, 133.714))                                                                       
   671 │       │       │      │       │       │       │               │       │test_route_1: Route = Route(Mongstad(), Mizushima())                                                                           
   672 │       │       │      │       │       │       │               │       │# kotzebue: Port = Port('Kotzebue', (66.898, -162.596))                                                                        
   673 │       │       │      │       │       │       │               │       │# murmansk: Port = Port('Murmansk', (68.958, 33.082))                                                                          
   674 │       │       │      │       │       │       │               │       │test_route_2: Route = Route(Kotzebue(), Murmansk())                                                                            
   675 │       │       │      │       │       │       │               │       │test_route_3: Route = Route(Tasiilap(), Mongstad())                                                                            
   676 │       │       │      │       │       │       │               │       │MONGSTAD = ('Mongstad', (60.810, 5.032))                                                                                       
   677 │       │       │      │       │       │       │               │       │MIZUSHIMA = ('Mizushima', (34.504, 133.714))                                                                                   
   678 │       │       │      │       │       │       │               │       │KOTZEBUE = ('Kotzebue', (66.898, -162.596))                                                                                    
   679 │       │       │      │       │       │       │               │       │MURMANSK = ('Murmansk', (68.958, 33.082))                                                                                      
   680 │       │       │      │       │       │       │               │       │REYKJAVIK = ('Reykjavik', (64.963, 19.103))                                                                                    
   681 │       │       │      │       │       │       │               │       │TASIILAP = ('Tasiilap', (65.604, -37.707))                                                                                     
   682 │       │       │      │       │       │       │               │       │                                                                                                                               
   683 │       │       │      │       │       │       │               │       │coordinates = [                                                                                                                
   684 │       │       │      │       │       │       │               │       │    [KOTZEBUE, MURMANSK],                                                                                                      
   685 │       │       │      │       │       │       │               │       │    [MURMANSK, REYKJAVIK],                                                                                                     
   686 │       │       │      │       │       │       │               │       │    [REYKJAVIK, TASIILAP],                                                                                                     
   687 │       │       │      │       │       │       │               │       │    [TASIILAP, MURMANSK]                                                                                                       
   688 │       │       │      │       │       │       │               │       │]                                                                                                                              
   689 │       │       │      │       │       │       │               │       │                                                                                                                               
   690 │       │       │      │       │       │       │               │       │def plot_route(route: Route, fuel: Type[Fuel], ship: Type[Ship]):                                                              
   691 │       │       │      │       │       │       │               │       │    result: SearchResult = A_star_search_algorithm(route.start.position, route.goal.position, ship, fuel)                      
   692 │       │       │      │       │       │       │               │       │                                                                                                                               
   693 │       │       │      │       │       │       │               │       │    path: NodeSet = result[0]                                                                                                  
   694 │       │       │      │       │       │       │               │       │    plot_path(path, data.init_map())                                                                                           
   695 │       │       │      │       │       │       │               │       │                                                                                                                               
   696 │       │       │      │       │       │       │               │       │    score: Score = result[1]                                                                                                   
   697 │       │       │      │       │       │       │               │       │    path_label: str = f"{ship.name} - {fuel.name} - {route} - {score}"                                                         
   698 │       │       │      │       │       │       │               │       │    data.save_coord_map(path_label)                                                                                            
   699 │       │       │      │       │       │       │               │       │    print(utils.separator)                                                                                                     
   700 │       │       │      │       │       │       │               │       │                                                                                                                               
   701 │       │       │      │       │       │       │               │       │def plot_between(start_place, end_place, fuel, ship):                                                                          
   702 │       │       │      │       │       │       │               │       │    path, score, search_successful = A_star_search_algorithm(start_place[1], end_place[1], fuel, ship)                         
   703 │       │       │      │       │       │       │               │       │    plot_path(path, data.init_map())                                                                                           
   704 │       │       │      │       │       │       │               │       │    data.save_coord_map(start_place[0] + ' to ' + end_place[0] + '(' + str(score) + ', ' + fuel.name + ')')                    
   705 │       │       │      │       │       │       │               │       │def test():                                                                                                                    
   706 │       │       │      │       │       │       │               │       │    for fuel in fuel_class.fuel_list:                                                                                          
   707 │       │       │      │       │       │       │               │       │        plot_route(test_route_1, fuel, ship_class.Prizna())                                                                    
   708 │       │       │      │       │       │       │               │       │        plot_route(test_route_2, fuel, ship_class.Prizna())                                                                    
   709 │       │       │      │       │       │       │               │       │        plot_route(test_route_3, fuel, ship_class.Prizna())                                                                    
   710 │       │       │      │       │       │       │               │       │                                                                                                                               
   711 │       │       │      │       │       │       │               │       │def profile():                                                                                                                 
   712 │       │       │      │       │       │       │               │       │    from scalene import scalene_profiler                                                                                       
   713 │       │       │      │       │       │       │               │       │    # profiler = cProfile.Profile()                                                                                            
   714 │       │       │      │       │       │       │               │       │    print("Starting profiling...")                                                                                             
   715 │       │       │      │       │       │       │               │       │    scalene_profiler.start()                                                                                                   
   716 │       │       │      │       │       │       │               │       │    plot_route(test_route_1, fuel_class.fuel_list[0], ship_class.ship_list[0])                                                 
   717 │       │       │      │       │       │       │               │       │    scalene_profiler.stop()                                                                                                    
   718 │       │       │      │       │       │       │               │       │    # profiler.disable()                                                                                                       
   719 │       │       │      │       │       │       │               │       │    # print("Dumping stats...")                                                                                                
   720 │       │       │      │       │       │       │               │       │    # stats = pstats.Stats(profiler).sort_stats('ncalls')                                                                      
   721 │       │       │      │       │       │       │               │       │    # stats.strip_dirs()                                                                                                       
   722 │       │       │      │       │       │       │               │       │    # stats.dump_stats('new_star_profiling')                                                                                   
   723 │       │       │      │       │       │       │               │       │    print("Finished.")                                                                                                         
   724 │       │       │      │       │       │       │               │       │                                                                                                                               
   725 │       │       │      │       │       │       │               │       │# plot_between(MONGSTAD, MIZUSHIMA, HEURISTIC_FUEL, vessel.ship_list[0])                                                       
   726 │       │       │      │       │       │       │               │       │# plot_between(MONGSTAD, KOTZEBUE, HEURISTIC_FUEL, vessel.ship_list[0])                                                        
   727 │       │       │      │       │       │       │               │       │# plot_between(KOTZEBUE, MURMANSK, HEURISTIC_FUEL, vessel.ship_list[0])                                                        
   728 │       │       │      │       │       │       │               │       │# plot_between(KOTZEBUE, REYKJAVIK, HEURISTIC_FUEL, vessel.ship_list[0])                                                       
   729 │       │       │      │       │       │       │               │       │# plot_between(KOTZEBUE, TASIILAP, HEURISTIC_FUEL, vessel.ship_list[0])                                                        
   730 │       │       │      │       │       │       │               │       │# 61.092643338340345, -20.37209268308615                                                                                       
   731 │       │       │      │       │       │       │               │       │# 59.55292944551115, 172.49462664899926                                                                                        
   732 │       │       │      │       │       │       │               │       │                                                                                                                               
   733 │       │       │      │       │       │       │               │       │# plot_between(start_coordinate, end_coordinate, HEURISTIC_FUEL)                                                               
   734 │       │       │      │       │       │       │               │       │# for fuel_type in fuel.fuel_list:                                                                                             
   735 │       │       │      │       │       │       │               │       │#     path, score = A_star_search_algorithm(start_coordinate, end_coordinate, fuel_type)                                       
   736 │       │       │      │       │       │       │               │       │#     if path != None:                                                                                                         
   737 │       │       │      │       │       │       │               │       │#         plot_path(path)                                                                                                      
   738 │       │       │      │       │       │       │               │       │#         dist_corr.save_coord_map(start_coordinate.__str__() + ' - ' + end_coordinate.__str__() + '(' + fuel_type.name + ',   
   739 │       │       │      │       │       │       │               │       │                                                                                                                               
   740 │       │       │      │       │       │       │               │       │# path = A_star_search_algorithm((61.093, 1.372), (55.552, 172.495), fuel_type=fuel.fuel_list[1])                              
   741 │       │       │      │       │       │       │               │       │# plot_path(path)                                                                                                              
   742 │       │       │      │       │       │       │               │       │# dist_corr.save_coord_map('PxtoPyfuel1')                                                                                      
   743 │       │       │      │       │       │       │               │       │                                                                                                                               
       │       │       │      │       │       │       │               │       │                                                                                                                               
╶──────┼───────┼───────┼──────┼───────┼───────┼───────┼───────────────┼───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │      │       │       │       │               │       │function summary for /home/herm/.git/dev-UA/src/a_star.py                                                                      
   366 │   64% │    6% │  28% │ 99%   │  85%  │  392M │█████████  20% │     2 │Scalene.A_star_search_algorithm                                                                                                
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                                                                                               
Top AVERAGE memory consumption, by line:
(1)   431:    42 MB                                                                                                                                                                                            
Top PEAK memory consumption, by line:
(1)   430:   392 MB                                                                                                                                                                                            
(2)   431:    42 MB                                                                                                                                                                                            
(3)   364:    41 MB                                                                                                                                                                                            
(4)     1:    30 MB                                                                                                                                                                                            
(5)   163:    20 MB                                                                                                                                                                                            
                                                             /home/herm/.git/dev-UA/src/data.py: % of time =   0.58% (1.314s) out of 4m:44.692s.                                                              
       ╷       ╷       ╷      ╷       ╷       ╷       ╷               ╷       ╷                                                                                                                               
       │Time   │–––––– │––––… │–––––– │Memory │–––––– │–––––––––––    │Copy   │                                                                                                                               
  Line │Python │native │syst… │GPU    │Python │peak   │timeline/%     │(MB/s) │/home/herm/.git/dev-UA/src/data.py                                                                                             
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │      │       │       │       │               │       │import fuel_class                                                                                                              
     2 │       │       │      │       │       │       │               │       │import ship_class                                                                                                              
     3 │       │       │      │       │       │       │               │       │                                                                                                                               
     4 │       │       │      │       │       │       │               │       │def data_list(s, t=0.0):                                                                                                       
     5 │       │       │      │       │       │       │               │       │    # velocity list                                                                                                            
     6 │       │       │      │       │       │       │               │       │    velocities = s.zero_initial_speed_vector()                                                                                 
     7 │       │       │      │       │       │       │               │       │    # ( fuel * ( velocity * kg ) ) list                                                                                        
     8 │       │       │      │       │       │       │               │       │    weights = [(f, [(v, s.fuel_for_trip(f, t=t, v=v), ) for v in velocities]) for f in fuel_class.fuel_list]                   
     9 │       │       │      │       │       │       │               │       │    # ( fuel * ( velocity * [€ / kg] ) list                                                                                    
    10 │       │       │      │       │       │       │               │       │    fuel_price = [(f, [(v, f.get_consumption_price(per_v_data)) for v, per_v_data in per_f_data]) for f, per_f_data in weight  
    11 │       │       │      │       │       │       │               │       │    # ( fuel * ( velocity * tons ) ) ) list                                                                                    
    12 │       │       │      │       │       │       │               │       │    emission_data = [(f, [(v, f.get_emission_tonnage(per_v_data)) for v, per_v_data in per_f_data]) for f, per_f_data in weig  
    13 │       │       │      │       │       │       │               │       │    # ( fuel * ( velocity * [€ / ton] ) ) list                                                                                 
    14 │       │       │      │       │       │       │               │       │    emission_price = [(f, [(v, f.get_emission_price(per_v_data)) for v, per_v_data in per_f_data]) for f, per_f_data in weigh  
    15 │       │       │      │       │       │       │               │       │    return (weights, fuel_price, emission_data, emission_price)                                                                
    16 │       │       │      │       │       │       │               │       │                                                                                                                               
    17 │       │       │      │       │       │       │               │       │def trip_duration_list(ship, thickness=0.0):                                                                                   
    18 │       │       │      │       │       │       │               │       │    # (ship * ( fuel * ( velocity * hours ) ) ) list                                                                           
    19 │       │       │      │       │       │       │               │       │    return [(v, ship.get_trip_duration(v, thickness=thickness)) for v in ship.feasible_speed_vector(thickness=thickness)]      
    20 │       │       │      │       │       │       │               │       │                                                                                                                               
    21 │       │       │      │       │       │       │               │       │from mpl_toolkits.basemap import Basemap                                                                                       
    22 │       │       │      │       │       │       │               │       │import math                                                                                                                    
    23 │       │       │      │       │       │       │               │       │import numpy as np                                                                                                             
    24 │       │       │      │       │       │       │               │       │import xarray as xr                                                                                                            
    25 │       │       │      │       │       │       │               │       │import matplotlib as mpl                                                                                                       
    26 │       │       │      │       │       │       │               │       │import matplotlib.pyplot as plt                                                                                                
    27 │       │       │      │       │       │       │               │       │import utils                                                                                                                   
    28 │       │       │      │       │       │       │               │       │                                                                                                                               
    29 │       │       │      │       │       │       │               │       │utils.print_entrypoint(__name__, __file__)                                                                                     
    30 │       │       │      │       │       │       │               │       │print('\tInitializing data...')                                                                                                
    31 │       │       │      │       │       │       │               │       │DATA_FILE = 'ice_thickness_2022.nc'                                                                                            
    32 │       │       │      │       │       │       │               │       │# Open xArray dataset, find the size in meters                                                                                 
    33 │       │       │      │       │       │       │               │       │dataset = xr.open_dataset(DATA_FILE)                                                                                           
    34 │       │       │      │       │       │       │               │       │meters = (np.shape(dataset['sea_ice_thickness'].coords['xc'])[0] - 1) * utils.unit_distance                                    
    35 │       │       │      │       │       │       │               │       │                                                                                                                               
    36 │       │       │      │       │       │       │               │       │def reinit_map():                                                                                                              
    37 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
    38 │       │       │      │       │       │       │               │       │    Reinitialize map for plot points.                                                                                          
    39 │       │       │      │       │       │       │               │       │    Largely boiler-plate, but made into a function for ease of calling's sake.                                                 
    40 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
    41 │       │       │      │       │       │       │               │       │    ax, fig = plt.subplots()                                                                                                   
    42 │       │       │      │       │       │       │               │       │    m = Basemap(width=meters, height=meters, projection='laea', lon_0=0., ellps='WGS84', lat_0=90., resolution='i')            
    43 │       │       │      │       │       │       │               │       │    m.drawparallels(np.arange(16.6239,90.,20.))                                                                                
    44 │       │       │      │       │       │       │               │       │    m.drawmeridians(np.arange(-180.,180.0,20.))                                                                                
    45 │       │       │      │       │       │       │               │       │    m.drawmapboundary(fill_color='gray')                                                                                       
    46 │       │       │      │       │       │       │               │       │    return m                                                                                                                   
    47 │       │       │      │       │       │       │               │       │                                                                                                                               
    48 │       │       │      │       │       │       │               │       │def plot_coord(lon: float, lat: float, lon_west=False, c='r', m=',', map=None):                                                
    49 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
    50 │       │       │      │       │       │       │               │       │    Function to plot a coordinate on the map given.                                                                            
    51 │       │       │      │       │       │       │               │       │    '''                                                                                                                        
    52 │       │       │      │       │       │       │               │       │    if lon_west:                                                                                                               
    53 │       │       │      │       │       │       │               │       │        lon = 360. - lon                                                                                                       
    54 │       │       │      │       │       │       │               │       │    x, y = map(lon, lat)                                                                                                       
    55 │       │       │      │       │       │       │               │       │    map.plot(x, y, marker=m, color=c)                                                                                          
    56 │       │       │      │       │       │       │               │       │                                                                                                                               
    57 │       │       │      │       │       │       │               │       │# Access icedata (for some reason, there is a time dimension)                                                                  
    58 │       │       │      │       │       │       │               │       │TIME = 0                                                                                                                       
    59 │       │       │      │       │       │       │               │       │icedata = dataset['sea_ice_thickness'].values[TIME]                                                                            
    60 │       │       │      │       │       │       │               │       │                                                                                                                               
    61 │       │       │      │       │       │       │               │       │# Shift coordinates based on the finding in terms of scale                                                                     
    62 │       │       │      │       │       │       │               │       │# This makes the top-left 0 m, 0 m                                                                                             
    63 │       │       │      │       │       │       │               │       │def shift(coordinate_component: float) -> float:                                                                               
    64 │       │       │      │       │       │       │               │       │    scaled_component = 1000.0 * coordinate_component                                                                           
    65 │       │       │      │       │       │       │               │       │    shifted_component = scaled_component + (meters / 2)                                                                        
    66 │       │       │      │       │       │       │               │       │    return shifted_component                                                                                                   
    67 │       │       │      │       │       │       │               │       │                                                                                                                               
    68 │       │       │      │       │       │       │               │       │vshift = np.vectorize(shift)                                                                                                   
    69 │       │       │      │       │       │       │               │       │x_coords = vshift(dataset['sea_ice_thickness'].coords['xc'])                                                                   
    70 │       │       │      │       │       │       │               │       │y_coords = vshift(dataset['sea_ice_thickness'].coords['yc'])                                                                   
    71 │       │       │      │       │       │       │               │       │                                                                                                                               
    72 │       │       │      │       │       │       │               │       │# Make a new map to store all the data, including ocean tiles                                                                  
    73 │       │       │      │       │       │       │               │       │                                                                                                                               
    74 │       │       │      │       │       │       │               │       │ice_values = np.empty(np.shape(icedata))                                                                                       
    75 │       │       │      │       │       │       │               │       │                                                                                                                               
    76 │       │       │      │       │       │       │               │       │for y, row in enumerate(dataset['status_flag'][TIME].values):                                                                  
    77 │       │       │      │       │       │       │               │       │    for x, status_flag in enumerate(row):                                                                                      
    78 │       │       │      │       │       │       │               │       │        match status_flag:                                                                                                     
    79 │       │       │      │       │       │       │               │       │            # If flag is 1: No data (mostly ocean outside the satellites range)                                                
    80 │       │       │      │       │       │       │               │       │            #            2: Open ocean                                                                                         
    81 │       │       │      │       │       │       │               │       │            case 1 | 2:                                                                                                        
    82 │       │       │      │       │       │       │               │       │                ice_values[y, x] = -0.5                                                                                        
    83 │       │       │      │       │       │       │               │       │            case _:                                                                                                            
    84 │       │       │      │       │       │       │               │       │                ice_values[y, x] = icedata[y, x]                                                                               
    85 │       │       │      │       │       │       │               │       │                                                                                                                               
    86 │       │       │      │       │       │       │               │       │# Since they are in range -0.5 to 11.0 we just shift a bit                                                                     
    87 │       │       │      │       │       │       │               │       │                                                                                                                               
    88 │       │       │      │       │       │       │               │       │for y, row in enumerate(ice_values):                                                                                           
    89 │       │       │      │       │       │       │               │       │    for x, datapoint in enumerate(row):                                                                                        
    90 │       │       │      │       │       │       │               │       │        if datapoint < 0.0:                                                                                                    
    91 │       │       │      │       │       │       │               │       │            ice_values[y, x] = 0.0                                                                                             
    92 │       │       │      │       │       │       │               │       │        elif datapoint > 11.0:                                                                                                 
    93 │       │       │      │       │       │       │               │       │            ice_values[y, x] = 11.0                                                                                            
    94 │       │       │      │       │       │       │               │       │                                                                                                                               
    95 │       │       │      │       │       │       │               │       │ICE_THICKNESS_MAX = np.nanmax(ice_values)                                                                                      
    96 │       │       │      │       │       │       │               │       │ICE_THICKNESS_MEAN = np.nanmean(ice_values)                                                                                    
    97 │       │       │      │       │       │       │               │       │# Color normalization scheme, behaves linearly until around the ice limit of the ships                                         
    98 │       │       │      │       │       │       │               │       │COLORMAP_NORM = mpl.colors.SymLogNorm(linthresh=2.4, vmin=0.0, vmax=ICE_THICKNESS_MAX)                                         
    99 │       │       │      │       │       │       │               │       │                                                                                                                               
   100 │       │       │      │       │       │       │               │       │# Make a mesh corresponding to the entire map for creating a figure                                                            
   101 │       │       │      │       │       │       │               │       │xx, yy = np.meshgrid(x_coords, y_coords)                                                                                       
   102 │       │       │      │       │       │       │               │       │# Draw the colormesh                                                                                                           
   103 │       │       │      │       │       │       │               │       │def reinit_colormesh(map):                                                                                                     
   104 │       │       │      │       │       │       │               │       │    cmap = mpl.cm.jet                                                                                                          
   105 │       │       │      │       │       │       │               │       │    cmap.set_bad('black',1.)                                                                                                   
   106 │       │       │      │       │       │       │               │       │    cm = map.pcolormesh(xx, yy, ice_values,                                                                                    
   107 │       │       │      │       │       │       │               │       │                        shading='nearest',                                                                                     
   108 │       │       │      │       │       │       │               │       │                        antialiased=True,                                                                                      
   109 │       │       │      │       │       │       │               │       │                        cmap=cmap,                                                                                             
   110 │       │       │      │       │       │       │               │       │                        norm = COLORMAP_NORM)                                                                                  
   111 │       │       │      │       │       │       │               │       │    map.colorbar(cm, extend='max', label='Ice Thickness', ticks=np.arange(0.0, ICE_THICKNESS_MAX, ICE_THICKNESS_MAX / 10.0))   
   112 │       │       │      │       │       │       │               │       │                                                                                                                               
   113 │       │       │      │       │       │       │               │       │def init_map():                                                                                                                
   114 │       │       │      │       │       │       │               │       │    map = reinit_map()                                                                                                         
   115 │       │       │      │       │       │       │               │       │    reinit_colormesh(map)                                                                                                      
   116 │       │       │      │       │       │       │               │       │    return map                                                                                                                 
   117 │       │       │      │       │       │       │               │       │                                                                                                                               
   118 │       │       │      │       │       │       │               │       │def save_coord_map(name):                                                                                                      
   119 │       │       │      │       │       │       │               │       │    plt.title(str(name) + " map")                                                                                              
   120 │       │       │      │       │       │       │               │       │    plt.show()                                                                                                                 
   121 │       │       │      │       │       │       │               │       │    if utils.verbose_mode:                                                                                                     
   122 │       │       │      │       │       │       │               │       │        print("\tSaving figure...")                                                                                            
   123 │       │       │      │       │       │       │               │       │    plt.savefig('images/' + str(name) + '.png')                                                                                
   124 │       │       │      │       │       │       │               │       │    if utils.verbose_mode:                                                                                                     
   125 │       │       │      │       │       │       │               │       │        print("\tFinished.")                                                                                                   
   126 │       │       │      │       │       │       │               │       │    plt.close()                                                                                                                
   127 │       │       │      │       │       │       │               │       │    if utils.verbose_mode:                                                                                                     
   128 │       │       │      │       │       │       │               │       │        utils.print_separator()                                                                                                
   129 │       │       │      │       │       │       │               │       │utils.print_exit(__name__, __file__)                                                                                           
       ╵       ╵       ╵      ╵       ╵       ╵       ╵               ╵       ╵                                                                                                                               
Top PEAK memory consumption, by line:
(1)    42:   567 MB                                                                                                                                                                                            
(2)   106:   283 MB                                                                                                                                                                                            
(3)   123:   248 MB                                                                                                                                                                                            
(4)    44:   120 MB                                                                                                                                                                                            
(5)   111:    42 MB                                                                                                                                                                                            
